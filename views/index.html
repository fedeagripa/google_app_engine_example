<html>
<head>
    <title>Aplicaciones escalables en la nube</title>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

    <style>
        .chat-window{
            border-radius: 4px;
            border:1px solid #ccc;
            height: 400px;
            margin-top:10px;
            margin-bottom:10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>{{ nickname }}</h1>
        <div id="contacts" class="col-lg-3">
            <form id="search-form">
                <input id="user-search-bar" name="search-text" type="text" class="form-control" placeholder="Buscar usuario">
            </form>

            <table id="search-results" class="table table-striped" style="display: none">
                <tbody></tbody>
            </table>

            <table id="contacts-table" class="table table-striped">
                <tbody>
                    {% for contact in contactList %}
                        <tr>
                            <td>
                                {{ contact.username }}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table> <!-- / .table -->
        </div>

        <div id="chat" class="col-lg-9">
            <div class="dropdown" style="float: right;">
                <button class="btn btn-default dropdown-toggle" type="button" id="menu-opciones" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                    Opciones
                    <span class="caret"></span>
                </button>
              <ul class="dropdown-menu" aria-labelledby="menu-opciones">
                <li><a id="send-file">Enviar archivo</a></li>
              </ul>
            </div>
            <div id="messages" class="col-lg-12 chat-window" style="">

            </div>
            <div class="col-lg-12">
                <form id="send-chat" method="post">
                    <input name="recipient" type="hidden" value="pepe">
                    <div class="col-lg-10">
                        <input name="message" type="text" class="form-control">
                    </div>
                    <div class="col-lg-2">
                        <input type="submit" class="btn btn-info" value="Enviar"/>
                    </div>
                </form>
                <div id="file-upload-container">

                </div>
                <form id="send-file-form" method="POST" enctype="multipart/form-data" >
                    <input id="upload" type="file" name="file" style="visibility: hidden;">
                </form>
            </div>



        </div>

    </div> <!-- / .container -->

    <script>
        $(document).ready(function(){

            $('#user-search-bar').on('input', function(){

                if($.trim($(this).val()) != '') { //controla que el input no este vacio

                    $.ajax({
                        type: "POST",
                        url: "/search",
                        data: $("#search-form").serialize(),
                        success: function(data) {

                            $('#search-results').find('tbody').empty();

                            var results = JSON.parse(data);

                            if(results.length > 0) {

                                $('#search-results').show();

                                for(i=0; i< results.length; i++){
                                    addContactToTable(results[i].nickname, results[i].mail)
                                }
                            }
                            else {
                                $('#search-results').hide();
                            }
                        }
                    });
                }
                else {
                    $('#search-results').find('tbody').empty();
                    $('#search-results').hide();
                }
            });

            //Obtiene la blobkey para subir el archivo
            $('#send-file').click(function(){

                $.ajax({
                    type: "GET",
                    url: "/upload_file_form",
                    success: function(data) {

                        $('#send-file-form').attr('action', data);

                    }
                });
                
                $('#upload').click();

            });


            //Sube el archivo
            $('#upload:file').change(function(){

                var upload_url = $('#send-file-form').attr('action');

                var formData = new FormData();
                formData.append('image', ($('#upload'))[0].files[0]);
                formData.append('blobkey', upload_url);

                $.ajax({
                    type: "POST",
                    url: upload_url,
                    cache: false,
                    contentType: false,
                    processData: false,
                    data: formData,
                    success: function(data) {
                        console.log(data);
                    }
                });
            });

            //Escucha cuando se clickea el agregar usuario
            $('#search-results').delegate('a','click', function () {

                var nickname = $(this).attr('nickname');

                $.ajax({
                    type: "POST",
                    url:'/add_contact',
                    data: {
                        nickname: nickname
                    },
                    success: function(data){

                        $('#contacts-table').find('tbody')
                                .append($('<tr>')
                                        .append($('<td>')
                                                .text(nickname)
                                        )
                                );

                        $('#search-results').find('tbody').empty();
                        $('#search-results').hide();
                        $('#user-search-bar').val('');

                    }
                });
            });
        });

        function addContactToTable(nickname, mail) {

            $('#search-results').find('tbody')
                                .append($('<tr>')
                                        .attr('mail', mail)
                                        .append($('<td>')
                                                .text(nickname)
                                        )
                                        .append($('<td>')
                                                .append($('<a>')
                                                        .attr('nickname', nickname)
                                                        .addClass('add-contact')
                                                        .append($('<span>')
                                                                .addClass('glyphicon glyphicon-plus')
                                                                .attr('aria-hidden','true')
                                                        )
                                                )
                                        )
                                );

        }

    </script>
</body>
</html>