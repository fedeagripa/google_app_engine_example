<html>
<head>
    <title>Aplicaciones escalables en la nube</title>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

    <script src='/_ah/channel/jsapi'></script>

    <style>
        .chat-window{
            border-radius: 4px;
            border:1px solid #ccc;
            height: 400px;
            margin-top:10px;
            margin-bottom:10px;
            overflow:scroll;
        }
    </style>
</head>
<body>
    <div class="container">
        <a style="float: right;" href="{{ logouturl }}">Salir</a>
        <h1>{{ nickname }}</h1>
        <div id="contacts" class="col-lg-3">
            <form id="search-form">
                <input id="user-search-bar" name="search-text" type="text" class="form-control" placeholder="Buscar" autocomplete="off">
            </form>

            <table id="search-results" class="table table-striped" style="display: none">
                <tbody></tbody>
            </table>

            <table id="contacts-table" class="table">
                <tbody>
                    {% for contact in contactList %}
                        <tr class="clickable-row">
                            <td id="{{ contact.username }}">
                                {{ contact.username }}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table> <!-- / .table -->
        </div>

        <div id="chat" class="col-lg-9">
            <div class="dropdown" style="float: right;">
                <button class="btn btn-default dropdown-toggle" type="button" id="menu-opciones" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                    Opciones
                    <span class="caret"></span>
                </button>
              <ul class="dropdown-menu" aria-labelledby="menu-opciones">
                <li><a id="send-file">Enviar archivo</a></li>
              </ul>
            </div>
            <div id="messages" class="col-lg-12 chat-window" style="">

            </div>
            <div class="col-lg-12">

                <input id="receiver" name="receiver" type="hidden">
                <div class="col-lg-10">
                    <input id="message" name="message" type="text" class="form-control" autocomplete="off">
                </div>
                <div class="col-lg-2">
                    <button id="send-message" class="btn btn-info" value="Enviar">Enviar</button>
                </div>

                <div id="file-upload-container">

                </div>
                <form id="send-file-form" method="POST" enctype="multipart/form-data" >
                    <input id="upload" type="file" name="file" style="visibility: hidden;">
                    <input id="file-receiver" type="hidden" name="file-receiver">
                </form>
            </div>



        </div>

    </div> <!-- / .container -->

    <script>
        $('#contacts-table').on('click', '.clickable-row', function(event) {
            $(this).addClass('active').siblings().removeClass('active');
        });
    </script>

    <script>
        $(document).ready(function(){

            $('#send-message').prop('disabled', true);
            $('#menu-opciones').prop('disabled', true);

            $('#user-search-bar').on('input', function(){

                if($.trim($(this).val()) != '') { //controla que el input no este vacio

                    $.ajax({
                        type: "POST",
                        url: "/search",
                        data: $("#search-form").serialize(),
                        success: function(data) {

                            $('#search-results').find('tbody').empty();

                            var results = JSON.parse(data);

                            results = results.results

                            if(results.length > 0) {

                                $('#search-results').show();

                                for(i=0; i< results.length; i++){
                                    addContactToTable(results[i].nickname, results[i].mail)
                                }
                            }
                            else {
                                $('#search-results').hide();
                            }
                        }
                    });
                }
                else {
                    $('#search-results').find('tbody').empty();
                    $('#search-results').hide();
                }
            });

            //Obtiene la blobkey para subir el archivo
            $('#send-file').click(function(){

                $.ajax({
                    type: "GET",
                    url: "/upload_file_form",
                    success: function(data) {

                        $('#send-file-form').attr('action', data);

                    }
                });
                
                $('#upload').click();

            });

            //Sube el archivo
            $('#upload:file').change(function(){

                var upload_url = $('#send-file-form').attr('action');

                var formData = new FormData();
                formData.append('image', ($('#upload'))[0].files[0]);
                formData.append('blobkey', upload_url);

                $.ajax({
                    type: "POST",
                    url: upload_url,
                    cache: false,
                    contentType: false,
                    processData: false,
                    data: formData,
                    success: function(data) {
                        console.log(data);
                    }
                });
            });

            //Escucha cuando se clickea el agregar usuario
            $('#search-results').delegate('a','click', function () {

                var nickname = $(this).attr('nickname');

                $.ajax({
                    type: "POST",
                    url:'/add_contact',
                    data: {
                        nickname: nickname
                    },
                    success: function(data){

                        $('#contacts-table').find('tbody')
                                .append($('<tr>')
                                        .append($('<td>')
                                                .text(nickname)
                                        )
                                );

                        $('#search-results').find('tbody').empty();
                        $('#search-results').hide();
                        $('#user-search-bar').val('');

                    }
                });
            });

            //Click en un contacto para comenzar a chatear
            $('#contacts-table').delegate('tr', 'click', function(){

                $(this).find('span.badge').remove();

                var receiver = $(this).children().text().trim();

                $('#file-receiver').val(receiver);
                $('#receiver').val(receiver);

                $('#send-message').prop('disabled', false);
                $('#menu-opciones').prop('disabled', false);

                $('#messages').empty();

                $.ajax({
                    type: "POST",
                    url:'/get_messages',
                    data: {
                        nickname: receiver
                    },
                    success: function(data){

                        var messages = JSON.parse(data);
                
                        if(messages.length > 0) {

                            for(i=messages.length-1; i>=0; i--){

                                if(messages[i].sender == receiver){
                                    $('#messages').append($('<p>').text(messages[i].sender + ': ' + messages[i].message));
                                }
                                else {
                                    $('#messages').append($('<p>').text('Yo: ' + messages[i].message));
                                }
                            }
                        }

                    }
                });

            });

            //Click del bot√≥n de enviar mensaje
            $('#send-message').click(function(){

                var message = $('#message').val();

                if($('#message').val().trim()){

                    $('#message').val('');

                    $('#messages').append($('<p>').text('Yo: ' + message));
                    $("#messages").scrollTop($("#messages")[0].scrollHeight);

                    var receiver = $('#receiver').val();

                    $.ajax({
                        type: "POST",
                        url:'/send_message',
                        data: {
                            receiver: receiver,
                            message: message
                        },
                        success: function(data){
                            console.log(data)
                        }
                    });
                }
            });
        });

        function addContactToTable(nickname, mail) {

            $('#search-results').find('tbody')
                                .append($('<tr>')
                                        .attr('mail', mail)
                                        .append($('<td>')
                                                .text(nickname)
                                        )
                                        .append($('<td>')
                                                .append($('<a>')
                                                        .attr('nickname', nickname)
                                                        .addClass('add-contact')
                                                        .append($('<span>')
                                                                .addClass('glyphicon glyphicon-plus')
                                                                .attr('aria-hidden','true')
                                                        )
                                                )
                                        )
                                );

        }

        onOpened = function() {
            //sendMessage('/opened');
        };

        onMessage = function(m) {

            var data = JSON.parse(m.data);

            var activeUser = $('#receiver').val();

            if(activeUser == data.sender){

                $('#messages').append($('<p>').text(data.sender + ': ' + data.message));
                $("#messages").scrollTop($("#messages")[0].scrollHeight);

            }
            else {

                if($('#' + data.sender).find('span.badge').length != 0){

                    var count = parseInt($('#' + data.sender).find('span.badge').text());
                    count++;
                    $('#' + data.sender).find('span.badge').text(count);
                }
                else {

                    $('#' + data.sender).append($('<span>').addClass('badge').css('float','right').text('1'));
                }
            }
        };

        openChannel = function() {
            var token = '{{ token }}';
            var channel = new goog.appengine.Channel('{{ token }}');
            var handler = {
              'onopen': onOpened,
              'onmessage': onMessage
            };
            var socket = channel.open(handler);

        };

        initialize = function() {
            openChannel();

        };

        setTimeout(initialize, 100);

    </script>
</body>
</html>